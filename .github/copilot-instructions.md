# SVG ESLint Parser - AI Coding Agent Instructions

## Project Overview

**svg-eslint-parser** is an ESLint-compatible parser for SVG files. It transforms SVG source code into an AST (Abstract Syntax Tree) compatible with ESLint's parser interface, enabling eslint rules to operate on SVG content.

Status: Work in progress (v0.0.5), not production-ready. API is unstable.

## Architecture & Data Flow

The parser follows a **three-stage pipeline**:

```
SVG Source → Tokenizer → Constructor → AST
```

### Stage 1: Tokenizer (`src/tokenizer/`)

- **Entry**: `tokenize.ts` returns `{ state, tokens }`
- **Handlers**: Located in `handlers/` — each manages a tokenization context (e.g., `attributeKey.ts`, `openTagStart.ts`)
- **State machine**: Context types from `TokenizerContextTypes` enum drive which handler processes each token
- **Output**: Array of `AnyToken` with precise `range` and `loc` (location) metadata

### Stage 2: Constructor (`src/constructor/`)

- **Purpose**: Builds AST from tokens using a state machine
- **Entry**: `constructTree(tokens)` builds AST using state machine
- **Main handler**: `processTokens()` iterates tokens, dispatching to context-specific handlers via `contextHandlers` record
- **State objects**: `ConstructTreeState<any>` manages current context, node references, and caret position
- **Context types**: `ConstructTreeContextTypes` enum (Tag, TagName, Attributes, etc.)
- **Output**: `{ state, ast: DocumentNode }`

### Stage 3: Parser (`src/parser/`)

- **Parse flow** (`parse.ts`): Tokenize → constructTree → clearParent (removes parent refs)
- **`parse.ts`**: Orchestrates tokenize → constructTree → `clearParent()` (removes bidirectional parent refs)
- **`parseForESLint.ts`**: Wraps Document in Program node, filters comment tokens, merges `visitorKeys`
- **`traverse.ts`**: Simple visitor using `visitorKeys` for ESLint compatibility

## Key Types & Node Structure

### Core Node Types

- **Document**: Root node containing children (tags, comments, text)
- **Program**: ESLint, contains children (tags, comments, text)
- **Program**: ESLint-required wrapper with `body`, `tokens`, `comments` arrays
- **Tag**: Element node with `attributes`, `children`, `openStart`, `openEnd`, `closeStart`, `closeEnd`
- **Attribute**: Key-value pair node (quotes stored in `quoteChar`)
- **Text, Comment, XMLDeclaration, Doctype**: Special node types

See [src/types/ast/](../src/types/ast/) for complete definitions.

### Token vs. Node Distinction

- **Tokens**: Low-level lexical units (`TokenTypes` enum) with exact positions — generated by tokenizer
- **Nodes**: Higher-level AST (`NodeTypes` enum) representing structure — generated by constructor
- Example: `<svg>` → OpenTagStart + TagName tokens → single

## Developer Workflows

### Common Commands

- `pnpm run build` — transpile TypeScript (uses `tsdown`)
- `pnpm run dev` — watch mode
- `pnpm run test` — run vitest (snapshot-based, see `tests/parse/__snapshots__/`)
- `pnpm run typecheck` — strict TypeScript check
- `pnpm run lint` — ESLint on source
- `pnpm run release:check` — lint + typecheck + test (run before commits)

### Testing Pattern

Tests use `vitest` with snapshot matching for AST validation:

```typescript
import { unindent as $ } from '@ntnyq/utils'
import { parseForESLint } from '../../src'

it('should parse svg', () => {
  const ast = parseForESLint($`<svg><circle cx="50" /></svg>`).ast
  expect(ast).toMatchSnapshot()
})
```

Use `unindent` utility for readable multi-line test inputs.

### Handler Pattern (Critical)

Both tokenizer and constructor use **handler dispatch by context type**:

```typescript
const contextHandlers: Record<ContextTypes, Handler> = {
  [ContextTypes.TagName]: tagNameHandler,
  // ...
}
// Lookup: const handler = contextHandlers[state.currentContext.type]
```

All new handlers MUST follow this pattern. Add new context types to corresponding enum (`TokenizerContextTypes` or `ConstructTreeContextTypes`) first.

### Constants as Single Source of Truth

All enum/type definitions live in `src/constants/`:

- `nodeTypes.ts` → `NodeTypes` enum
- `tokenTypes.ts` → `TokenTypes` enum
- `tokenizerContextTypes.ts` → `TokenizerContextTypes` enum
- `constructTreeContextTypes.ts` → `ConstructTreeContextTypes` enum
- `svgElements.ts` → Self-closing elements set
- `specialChar.ts` → Character/sequence literals

Import from `constants/` index, not individual files.

### Utilities Organization

1. **Remove `any` types** — particularly in:
   - `clearParent()` should use generics: `<T extends AnyNode>(ast: T): T`
   - Handler state parameters should be properly typed, not `state: any`
   - `traverse()` uses `@ts-expect-error` — needs node type refinement

2. **Defensive checks** — handlers assume non-null state properties:
   - Check `state.currentNode.name` before using (can be undefined)
   - Validate `state.currentContext` exists before dispatching

## Performance Notes

- `CharsBuffer.length()` recalculates every call via reduce — consider caching
- `getLineInfo()` scans source string linearly for every token — consider memoization for large files
- Recursive traversal in `traverseAST()`, `nodeHelpers.ts` may hit stack limits on deeply nested SVGs
- `SourceCode` creates `Chars[]` for every character — memory intensive for large files

## ESLint Integration Points

- **VisitorKeys** (`visitorKeys.ts`): Defines traversable properties per node type, merged with ESLint defaults via `unionWith()`
- **ParseForESLint return**: Must include `{ ast, visitorKeys, services: { isSVG: true } }`
- **Comment handling** (`parseForESLint.ts`): Filters comment tokens, extracts content into comments array via traverse

## Testing & Debugging Tips

- `parseForESLint(source).ast` to inspect AST structure
- `tokenize(source).tokens` to debug tokenization
- `constructTree(tokens).ast` to debug AST construction
- Snapshots in `tests/parse/__snapshots__/` — update with `pnpm test -- -u`
- Common test source: ESLint logo SVG (see `base.test.ts`)

## Dependencies

**Runtime** (minimal):

- `@ntnyq/utils` — string utilities (unindent, etc.)
- `eslint-visitor-keys` — merges custom visitorKeys with ESLint defaults

**Dev**:

- `tsdown` — TypeScript transpiler
- `vitest` — test runner
- `typescript 5.9+` — strict type checking

**No external XML/SVG parsing libraries** — all implemented from scratch using state machines
**Minimal dependencies**:

- `@ntnyq/utils`: String utilities (unindent, etc.)
- `eslint-visitor-keys`: Merges custom visitorKeys with ESLint defaults
- Dev: `tsdown` (TypeScript bundler), `vitest` (test runner), `typescript 5.9+`

**No external SVG parsing**: Implements from scratch using state machine (not using DOM/XML libraries).
